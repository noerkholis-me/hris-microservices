generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  moduleFormat    = "cjs"
}


datasource db {
  provider = "postgresql"
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  username          String    @unique
  passwordHash      String    @map("password_hash")
  emailVerified     Boolean   @default(false) @map("email_verified")
  isActive          Boolean   @default(true) @map("is_active")
  isSuspended       Boolean   @default(false) @map("is_suspended")
  suspendedAt       DateTime? @map("suspended_at")
  suspendedReason   String?   @map("suspended_reason")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLoginAt       DateTime? @map("last_login_at")
  passwordChangedAt DateTime? @map("password_changed_at")

  roles             UserRole[]
  refreshTokens     RefreshToken[]
  loginHistory      LoginHistory[]
  passwordResets    PasswordReset[]
  emailVerifications EmailVerification[]

  employeeId        String?   @unique @map("employee_id")

  @@index([email])
  @@index([employeeId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  isSystem    Boolean  @default(false) @map("is_system")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model UserRole {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  roleId     String    @map("role_id")

  validFrom  DateTime? @map("valid_from")
  validUntil DateTime? @map("valid_until")

  assignedBy String?   @map("assigned_by")
  assignedAt DateTime  @default(now()) @map("assigned_at")

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // employee, attendance, leave, payroll
  action      String   // create, read, update, delete, approve
  scope       String?  // own, department, all
  displayName String   @map("display_name")
  description String?

  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@unique([resource, action, scope])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")

  grantedAt    DateTime   @default(now()) @map("granted_at")
  grantedBy    String?    @map("granted_by")

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  deviceId  String?  @map("device_id")
  userAgent String?  @map("user_agent")
  ipAddress String?  @map("ip_address")

  isRevoked Boolean  @default(false) @map("is_revoked")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model LoginHistory {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  ipAddress  String      @map("ip_address")
  userAgent  String?     @map("user_agent")
  deviceId   String?     @map("device_id")

  status     LoginStatus
  failReason String?     @map("fail_reason")

  loginAt    DateTime    @default(now()) @map("login_at")
  logoutAt   DateTime?   @map("logout_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
  @@map("login_history")
}

enum LoginStatus {
  SUCCESS
  FAILED
  BLOCKED
  SUSPICIOUS
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique

  isUsed    Boolean  @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique

  isUsed    Boolean  @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verifications")
}
